<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  <!--meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" /-->
  <meta name="viewport" content="user-scalable=yes, width=device-width, height=device-height" />
  <title>Settings</title>

  <link rel="stylesheet" type="text/css" href="css/app_styles.css" />
  <script src="js/commons.js"></script>
  <script type="text/javascript" src="js/pouchdb.min.js"> </script>
  <script src="js/faceDetectionControls.js"></script>
  <!-- link rel="stylesheet" href="css/index.css" -->
  <!--link rel="stylesheet" href="css/styles.css"-->
  <link rel="stylesheet" href="css/materialize.css">
  <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
  <script src="js/materialize.min.js"></script>
  <style type="text/css">
    .selectedFaces {
      left: 900px;
      top: 0px;
      margin-top: 50px;
      position: absolute;
    }

    #selectedFaces canvas {
      margin-top: 10px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="app">
  <div id="navbar"></div>
  <div class="center-content page-container">
    <div class="progress" id="loader">
      <div class="indeterminate"></div>
    </div>
    <table><tbody>
      <tr>
      <td> <label for="selectFaceDetector">Select Face Detector:</label> </td>
      <td>
        <select id="selectFaceDetector">
          <option value="ssd_mobilenetv1">SSD Mobilenet V1</option>
          <option value="tiny_face_detector">Tiny Face Detector</option>
        </select>
      </td>
      </tr>
      <tr>
        <td> <label for="minConfidence">Min Confidence:</label> </td>
        <td>
        <input disabled value="0.5" id="minConfidence" type="text" class="inputCustom bold">
        <button
          class="waves-effect waves-light btn"
          onclick="onDecreaseMinConfidence()"
        >
          <i class="material-icons left">-</i>
        </button>
        <button
          class="waves-effect waves-light btn"
          onclick="onIncreaseMinConfidence()"
        >
          <i class="material-icons left">+</i>
        </button>
      </td>
    </tr>

    <tr>
      <td> <label for="inputSize">Input Size</label> </td>
       <td>   <select id="inputSize">
            <option value="" disabled selected>Input Size:</option>
            <option value="128">128 x 128</option>
            <option value="160">160 x 160</option>
            <option value="224">224 x 224</option>
            <option value="320">320 x 320</option>
            <option value="416">416 x 416</option>
            <option value="512">512 x 512</option>
            <option value="608">608 x 608</option>
          </select>
        </td>
      </tr>
      <tr>
        <td> <label for="scoreThreshold">Score Threshold:</label> </td>
        <td> <input disabled value="0.5" id="scoreThreshold" type="text" class="inputCustom bold">
        <button
          class="waves-effect waves-light btn"
          onclick="onDecreaseScoreThreshold()"
        >
          <i class="material-icons left">-</i>
        </button>
        <button
          class="waves-effect waves-light btn"
          onclick="onIncreaseScoreThreshold()"
        >
          <i class="material-icons left">+</i>
        </button>
      </td>
      </tr>
      <tr>
      <td> <label for="maxFRThreshold">Max FR Distance:</label> </td>
      <td>
      <input disabled value="0.55" id="maxFRThreshold" type="text" class="inputCustom bold">
      <button
        class="waves-effect waves-light btn"
        onclick="onDecreaseFRThreshold()"
      >
        <i class="material-icons left">-</i>
      </button>
      <button
        class="waves-effect waves-light btn"
        onclick="onIncreaseFRThreshold()"
      >
        <i class="material-icons left">+</i>
      </button>
    </td>
    </tr>

    <!-- Location lat long -->
    <tr class="row side-by-side">
      <td><label for="latitude">Latitude:</label></td>
      <td><input id="latitude" type="text" class="inputCustom bold"></td>
    </tr>
    <tr class="row side-by-side">
      <td><label for="longitude">Longitude:</label></td>
      <td><input id="longitude" type="text" class="inputCustom bold"></td>
    </tr>
    <!-- Camera Settings -->
    <tr class="row side-by-side">
      <td><label for="camera">Default Camera:</label></td>
      <td><select id="camera" class="selectCustom bold">
        <option value="back">Back camera</option>
        <option value="front">Front camera</option>
      </select>
      </td>
    </tr>
    <tr class="row side-by-side">
      <td><label for="zoom">Zoom:</label></td>
      <td><input id="zoom" type="number" class="inputCustom bold"></td></td>
    </tr>
    <tr class="row side-by-side">
      <td><label for="countries">Countries:</label></td>
      <td><textarea id="countries" class="textareaCustom bold"></textarea></</td>>
    </tr>
    <tr class="row side-by-side">
      <td><label for="categories">Categories:</label></td>
      <td><textarea id="categories" class="textareaCustom bold"></textarea></td>
    </tr>

  </tbody></table>
  </div>
  </div>

  <footer>
    <img src="images/logo_36x36.png" >
    <span class="footer_area">Powered By INICAI and PTPL </span>
  </footer>

  <script src="cordova.js"></script>

  <script>
    let use_cordova_plugin = window.cordova;
    let defaultCountiesList = 'India,Pakistan,Somalia,Iran,Afghanistan,East Africa,Kenya,Male,Burundi,Rwanda,Uganda,Maldives,Tajikistan,Turkmenistan,Kazakhstan,Kyrgyz Republic,Uzbekistan';
    let defaultCategories = 'Normal Person,Govt Security,Private Security,Criminal';

    async function docExists(db, docId) {
      let ret = await db.get(docId).then((doc) => doc).catch(() => false)
      return ret
    }

    async function attachmentExists(db, docId, attachmentId) {
      let ret = await db.getAttachment(docId, attachmentId).then((doc) => doc).catch(() => false)
      return ret
    }

    // doc returned by allDocs when include_docs and attachments is not specified
    async function removeFromDb(db, doc) { await db.remove(doc.id, doc.value.rev) }

    async function clearFacesDB(db) {
        let alldocs = await db.allDocs()
        await Promise.all(alldocs.rows.map(
          async doc => {
            removeFromDb(db, doc)
          }))
    }

    // onSuccess Callback
    // This method accepts a Position object, which contains the
    // current GPS coordinates
    //
    var geolocationSuccess = function(position) {
        console.log('Latitude: '          + position.coords.latitude          + '\n' +
              'Longitude: '         + position.coords.longitude         + '\n' +
              'Altitude: '          + position.coords.altitude          + '\n' +
              'Accuracy: '          + position.coords.accuracy          + '\n' +
              'Altitude Accuracy: ' + position.coords.altitudeAccuracy  + '\n' +
              'Heading: '           + position.coords.heading           + '\n' +
              'Speed: '             + position.coords.speed             + '\n' +
              'Timestamp: '         + position.timestamp                + '\n');
        $('#latitude').val(position.coords.latitude);
        $('#longitude').val(position.coords.longitude);
        updateResults();
    };

    // onError Callback receives a PositionError object
    //
    function geolocationError(error) {
        console.log('Error in obtaining geolocation:', error);
    }

    async function run() {
      document.body.style.minHeight = `${window.screen.height}px`;


      let faces_settings_db = new PouchDB('faces_settings_db')
      let settings = await docExists(faces_settings_db, 'settings')
      if(settings) { // Get from settings
        await changeFaceDetector(settings.faceDetector, false)
        changeInputSize(settings.inputSize)
        maxFRThreshold = settings.maxFRThreshold
        // ssd_mobilenetv1 options
        minConfidence = settings.minConfidence
        // tiny_face_detector options
        inputSize = settings.inputSize
        scoreThreshold = settings.scoreThreshold
        $('#maxFRThreshold').val(maxFRThreshold)
        $('#minConfidence').val(minConfidence)
        $('#scoreThreshold').val(scoreThreshold)
        $('#latitude').val(settings.latitude ? settings.latitude : '')
        $('#longitude').val(settings.longitude ? settings.longitude : '')
        $('#camera').val(settings.camera ? settings.camera : 'back')
        $('#zoom').val(settings.zoom ? settings.zoom : 10)
        $('#countries').val(settings.countries ? settings.countries : defaultCountiesList)
        $('#categories').val(settings.categories ? settings.categories : defaultCategories)
      }
      $('#latitude').on('change', updateResults)
      $('#longitude').on('change', updateResults)
      $('#camera').on('change', function() {
        //$('#camera').material_select()
        updateResults()
      })

      $('#zoom').on('change', updateResults)
      $('#countries').on('change', updateResults)
      $('#categories').on('change', updateResults)

      navigator.geolocation.getCurrentPosition(geolocationSuccess,
                                               geolocationError,
                                              { maximumAge: 10000, timeout: 10000, enableHighAccuracy: true });
    }

    async function updateResults() {
      let faces_settings_db = new PouchDB('faces_settings_db')
      let settings = await docExists(faces_settings_db, 'settings')
      settings['faceDetector'] = selectedFaceDetector
      settings['minConfidence'] = minConfidence
      settings['inputSize'] = inputSize
      settings['scoreThreshold'] = scoreThreshold
      settings['maxFRThreshold'] = maxFRThreshold
      settings['latitude'] = $('#latitude').val()
      settings['longitude'] = $('#longitude').val()
      settings['camera'] = $('#camera').val()
      settings['zoom'] = parseInt($('#zoom').val())
      settings['countries'] = $('#countries').val().trim()
      settings['categories'] = $('#categories').val().trim()
      await faces_settings_db.put(settings)
    }

    async function pageOnDeviceReady() {
      renderNavBar('#navbar', 'settings.html')
      initFaceDetectionControls()
      run()
    }

    if(use_cordova_plugin)
      document.addEventListener('deviceready', pageOnDeviceReady, false);
    else
      $(document).ready(function() {
      renderNavBar('#navbar', 'settings.html')
      initFaceDetectionControls()
      run()
    })

    window.onbeforeunload =  function(){
      console.log("Saving results before leaving page")
      updateResults()
    };

    /*
    window.onunload = function(){
    };
*/

  </script>
</body>
</html>
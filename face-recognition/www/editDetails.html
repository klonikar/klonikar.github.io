<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  <!--meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" /-->
  <meta name="viewport" content="user-scalable=yes, width=device-width, height=device-height" />
  <title>Edit Details</title>

  <link rel="stylesheet" type="text/css" href="css/app_styles.css" />
  <script src="js/commons.js"></script>
  <script type="text/javascript" src="js/pouchdb.min.js"> </script>
  <!-- link rel="stylesheet" href="css/index.css" -->
  <!--link rel="stylesheet" href="css/styles.css"-->
  <link rel="stylesheet" href="css/materialize.css">
  <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
  <script src="js/materialize.min.js"></script>
  <style type="text/css">
    .highlightedSection {
      .color: red;
      .font-weight: bold;
    }

    .selected_recognized_image {
      max-width: 25%;
    }

  </style>
</head>
<body>
  <div class="app">
  <div id="navbar"></div>
  <div class="center-content page-container">
    <div class="row side-by-side">
      <!-- person selection -->
      <label for="selectPerson">Select Person:</label>
      <select id="selectPerson" type="text" class="selectCustom bold">
      </select>
    </div>

    <div class="highlightedSection row side-by-side" id="registeredFaceImages">
    </div>
    <!-- Person details -->
    <div class="row side-by-side">
      <label for="name">Full Name:</label>
      <input id="name" type="text" class="inputWideCustom bold">
    </div>
    <div class="row side-by-side">
      <label for="age">Age:</label>
      <input id="age" type="number" class="inputCustom bold">
    </div>
    <div class="row side-by-side">
      <label for="gender">Gender:</label>
      <select id="gender" class="selectCustom bold">
        <option value="M">Male</option>
        <option value="F">Female</option>
        <option value="O">Other</option>
      </select>
    </div>

    <div class="row side-by-side">
      <label for="country">Nationality:</label>
      <select id="country" type="text" class="selectCustom bold">
      </select>
    </div>
    <div class="row side-by-side">
      <label for="category">Category:</label>
      <select id="category" class="selectCustom bold">
      </select>
    </div>

    <!-- Save person -->
    <div class="row side-by-side">
      <button
        class="waves-effect waves-light btn"
        onclick="savePersonDetails()"
      >
        <i class="material-icons left">Save</i>
      </button>
    </div>

  </div>
  </div>

  <footer>
    <img src="images/logo_36x36.png" >
    <span class="footer_area">Powered By INICAI and PTPL </span>
  </footer>

  <script src="cordova.js"></script>

  <script>
    let use_cordova_plugin = window.cordova;
    let faces_db = null;
    let person_db = null;
    let faces_docs = null;
    let selectedPerson = null;
    let defaultCountiesList = 'India,Pakistan,Somalia,Iran,Afghanistan,East Africa,Kenya,Male,Burundi,Rwanda,Uganda,Maldives,Tajikistan,Turkmenistan,Kazakhstan,Kyrgyz Republic,Uzbekistan'
    let defaultCategories = 'Normal Person,Govt Security,Private Security,Criminal';


    function getQueryParams() {
      let qs = window.location.search || document.location.search;
      qs = qs.split("+").join(" ");

      let params = {}, tokens,
          re = /[?&]?([^=]+)=([^&]*)/g;

      while (tokens = re.exec(qs)) {
          params[decodeURIComponent(tokens[1])]
              = decodeURIComponent(tokens[2]);
      }

      return params;
    }

    async function docExists(db, docId, options={}) {
      let ret = await db.get(docId, options).then((doc) => doc).catch(() => false)
      return ret
    }

    async function attachmentExists(db, docId, attachmentId) {
      let ret = await db.getAttachment(docId, attachmentId).then((doc) => doc).catch(() => false)
      return ret
    }

    // doc returned by allDocs when include_docs and attachments is not specified
    async function removeFromDb(db, doc) { await db.remove(doc.id, doc.value.rev) }

    async function clearFacesDB(db) {
        let alldocs = await db.allDocs()
        await Promise.all(alldocs.rows.map(
          async doc => {
            removeFromDb(db, doc)
          }))
    }

    async function savePersonDetails() {
      selectedPerson.name = $('#name').val()
      selectedPerson.age = $('#age').val()
      selectedPerson.gender = $('#gender').val()
      selectedPerson.country = $('#country').val()
      selectedPerson.category = $('#category').val()
      // TODO: Add other fields from the UI to selectedPerson
      let personDbRec = await docExists(person_db, selectedPerson._id, {})
      if(personDbRec) {
        selectedPerson._rev = personDbRec._rev
      }
      let ret = await person_db.put(selectedPerson)
      console.log('Saved person data. Status:', ret)
      // TODO: Save the person name to faces_db also if it has changed.
    }

    function showRegisteredImages(name) {
      $('#registeredFaceImages').empty()
      let filteredNames = faces_docs.rows.filter(d => d.doc._id == name)
      if(!filteredNames || filteredNames.length == 0) {
        console.log(`No face registered by ${name}`)
        $('#registeredFaceImages').html(`No face registered by ${name}`)
        return
      }
      let selectedPersonFaceDoc = filteredNames[0].doc
      let imageAttachments = Object.keys(selectedPersonFaceDoc._attachments).filter(k => k.split('.')[1] == 'png')
      imageAttachments.forEach((a, i) => {
          let img = new Image()
          img.src = "data:image/png;base64," + selectedPersonFaceDoc._attachments[a].data
          img.className = 'selected_recognized_image'
          $('#registeredFaceImages').append(img)
      })
    }

    async function changePerson(name) {
      $('#selectPerson').val(name)
      //$('#selectPerson').material_select()
      selectedPerson = await docExists(person_db, name, {attachments: true})
      if(!selectedPerson) {
        console.log('No record for selected person:', name, '. Looking in registered faces db.')
        let filteredNames = faces_docs.rows.filter(d => d.doc._id == name)
        console.log(`Registered faces for ${name}:`, filteredNames)
        if(filteredNames && filteredNames.length > 0) {
          let selectedPersonFaceDoc = filteredNames[0].doc
          selectedPerson = {
            '_id': selectedPersonFaceDoc._id,
            'name': selectedPersonFaceDoc.name
          }
          $('#name').val(selectedPerson.name)
          showRegisteredImages(name)
        }
        else {
          console.log('No registered face by name: ', name)
        }
        return;
      }
      $('#name').val(selectedPerson.name)
      $('#age').val('age' in selectedPerson ? selectedPerson.age : '')
      $('#gender').val('gender' in selectedPerson ? selectedPerson.gender : '')
      //$('#gender').material_select()
      $('#country').val(selectedPerson.country)
      //$('#country').material_select()
      $('#category').val('category' in selectedPerson ? selectedPerson.category : '')
      //$('#category').material_select()
      showRegisteredImages(name)
    }

    async function onPersonSelected(e) {
      await changePerson(e.target.value)
      updateResults()
    }

    async function run() {
      document.body.style.minHeight = `${window.screen.height}px`;

      let faces_settings_db = new PouchDB('faces_settings_db')
      let settings = await docExists(faces_settings_db, 'settings')
      if(settings) {
        let countries = settings.countries ? settings.countries : defaultCountiesList
        countries.trim().split(',').forEach(c => $('#country').append(`<option value="${c.trim()}">${c.trim()}</option>`))
        let categories = settings.categories ? settings.categories : defaultCategories;
        categories.trim().split(',').forEach(c => $('#category').append(`<option value="${c.trim()}">${c.trim()}</option>`))
      }
      faces_db = new PouchDB('faces_db')
      faces_docs = await faces_db.allDocs({include_docs: true, attachments: true})
      let names = faces_docs.rows.map(d => 
        {return {name: d.doc.name, _id: d.doc._id};
      })
      names.forEach((n, i) => {
        let opt = document.createElement('option')
        opt.value = n._id
        opt.innerHTML = n.name
        $('#selectPerson').append(opt)
      })
      $('#selectPerson').get(0).selectedIndex = -1
      $('#selectPerson').on('change', onPersonSelected)
      //$('#selectPerson').material_select()
      person_db = new PouchDB('person_db')
      let params = getQueryParams()
      if(names.length > 0 && 'id' in params) {
        let id = params['id']
        changePerson(id)
      }
    }

    async function updateResults() {
    }

    async function pageOnDeviceReady() {
      renderNavBar('#navbar', 'editDetails.html')
      run()
    }

    if(use_cordova_plugin)
      document.addEventListener('deviceready', pageOnDeviceReady, false);
    else
      $(document).ready(function() {
      renderNavBar('#navbar', 'editDetails.html')
      run()
    })

    window.onbeforeunload =  function(){
      console.log("Saving results before leaving page")
      updateResults()
    };

    /*
    window.onunload = function(){
    };
*/

  </script>
</body>
</html>
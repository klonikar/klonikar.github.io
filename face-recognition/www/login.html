<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy"
        content="script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="user-scalable=yes, width=device-width, height=device-height, initial-scale=1.0" />
    <title>Satyapan.AI</title>

    <link rel="stylesheet" href="css/materialize.css">
    <script type="text/javascript" src="js/pouchdb.min.js"> </script>
    <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="js/licenseUtils.js"> </script>
    <script src="js/materialize.min.js"></script>

    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            background: url('images/indian_navy_full.png') no-repeat center center fixed;
            background-size: cover;
        }

        .login-container {
            /* text-align: center; */
            color: white;
        }

        .login-container h1 {
            margin: 0 0 20px 0;
            font-size: 24px;
        }

        .login-container label {
            display: block;
            margin: 10px 0 5px 0;
        }

        .login-container input[type="text"],
        .login-container input[type="password"] {
            width: 90%;
            padding: 10px;
            margin: 5px 0 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.8);
            color: black;
            font-weight: 400;
        }

        .login-container button {
            width: 80%;
            padding: 10px;
            background-color: #340379;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            font-weight: 400;
        }

        .login-container button:hover {
            background-color: #3700b3;
        }

        .footer {
            margin-top: 180px;
            color: white;
            font-size: 30px
        }

        .footer img {
            width: 80px;
            height: 100px;
            vertical-align: middle;
        }

        .welcome {
            font-size: 2.3rem;
            margin-left: 25px;
        }

        .heading_div {
            margin-bottom: 6rem;
            font-weight: 600;
            margin-left: 35px;
        }

        .appTitle {
            font-size: 3rem;
            /* margin-top: -10px; */
        }

        .signin {
            align-items: center;
            justify-content: center;
            margin-top: 20px !important;
        }

        .label_div {
            color: #fff;
            font-weight: 800;
            font-size: 20px;
            margin-top: 35px !important;
        }

        .image_div {
            margin-left: 120px;
        }

        .textAreaColor {
            color: white !important;
        }

        .licenseWarning {
            color: darkred;
            font-size: large;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="heading_div">
            <div class="welcome">WELCOME TO</div>
            <div class="appTitle bold">SATYAPAN.AI</div>
        </div>

        <div id="loginControls">
            <label id="usernameLabel" class="label_div" for="username">Username</label>
            <input type="text" id="username" name="username" value="IndianNavy" required>
            <label id="passwordLabel" class="label_div" for="password">Password</label>
            <input type="password" id="password" name="password" value="********" required>
            <div class="signin">
                <button id="loginButton" style="width: 100px !important;margin-left: 30% !important;" onclick="logInHandle(event);">Sign in</button>
            </div>
        </div>

        <div id="registerProductControls" hidden>
            <label id=""deviceidLabel class="label_div" for="deviceid">Device Id</label>
            <input type="text" id="deviceid" name="deviceid" value="" readonly>
            <span class="licenseWarning">Send this Device Id to the product vendor and obtain license key. After obtaining, enter it in the below field and press Register button.</span>
            <label id="licenseKeyLabel" class="label_div" for="licenseKey">License Key</label>
            <textarea type="licenseKey" id="licenseKey" name="licenseKey" value="" class="textareaCustom bold textAreaColor ms-2">
            </textarea>
            <div class="signin">
                <button id="registerProductButton" style="width: 100px !important;margin-left: 30% !important;" onclick="registerProduct(event);">Register</button>
            </div>
        </div>

        <div class="footer">
            Powered By INICAI & PTPL
            <div class="image_div">
                <img src="images/logo-1.png" style="width: 50px; height: 60px;" alt="Logo">
                <img src="images/ptpl_logo.svg" style="margin-left: 10px;" alt="Logo">
            </div>


        </div>
    </div>

    <script src="cordova.js"></script>
    <script>
        let publicKey = '48,130,2,34,48,13,6,9,42,134,72,134,247,13,1,1,1,5,0,3,130,2,15,0,48,130,2,10,2,130,2,1,0,172,142,108,213,73,58,184,179,59,250,47,166,128,230,180,61,161,57,124,197,66,173,162,214,104,110,76,171,16,129,7,66,192,177,191,216,80,197,105,156,16,72,239,38,89,120,85,240,14,98,44,78,151,34,33,238,174,93,138,90,84,230,134,120,150,169,140,214,155,185,219,64,52,167,219,102,197,68,117,196,218,144,136,242,19,123,153,107,50,206,11,223,28,6,175,235,26,233,1,89,94,113,191,211,99,6,61,88,149,185,51,192,156,189,3,129,51,110,48,170,238,150,27,189,254,35,181,75,65,162,206,237,45,140,77,2,227,42,206,11,97,234,190,154,56,85,232,103,112,145,227,82,57,50,183,54,227,242,159,58,124,158,2,130,111,235,137,21,141,43,213,82,68,139,161,107,4,42,92,88,187,251,167,77,194,255,172,56,23,134,255,208,163,67,113,163,64,40,188,186,158,146,157,105,15,63,87,160,26,212,201,58,51,140,51,123,175,160,109,145,200,83,200,61,190,89,127,220,72,252,20,71,42,185,44,113,105,227,193,176,223,251,237,16,184,249,93,52,30,115,185,10,197,59,184,7,125,212,81,31,132,73,125,211,119,90,131,200,126,58,163,22,14,200,87,157,11,48,12,16,144,121,40,159,45,103,129,212,28,110,2,26,251,125,86,204,221,10,16,47,95,78,198,251,144,255,141,208,138,61,3,10,121,21,157,243,108,129,97,24,80,108,87,194,155,17,28,104,83,24,168,71,31,109,141,2,162,144,124,6,160,181,48,108,21,136,196,62,190,103,49,81,137,236,201,249,228,26,145,127,254,102,166,15,7,75,182,155,82,185,162,15,211,65,27,41,218,150,140,134,94,93,111,193,28,233,223,238,85,98,173,11,104,255,40,170,24,41,132,85,192,203,87,72,100,67,188,241,93,5,200,198,215,48,169,155,151,68,46,82,245,232,110,117,102,36,155,68,31,45,40,244,76,191,49,184,168,32,227,178,19,175,40,233,30,228,82,123,226,70,139,51,90,174,78,58,78,126,136,147,17,173,248,226,153,182,183,143,204,18,27,31,180,127,159,53,86,71,99,17,192,39,212,92,148,100,98,188,33,115,42,130,231,219,107,50,199,211,238,200,192,204,97,153,243,86,129,123,213,67,206,13,2,3,1,0,1';

        function hideLoginControls() {
            document.getElementById('loginControls').setAttribute('hidden', true);
        }

        function showLoginControls() {
            document.getElementById('loginControls').removeAttribute('hidden');
        }

        function showRegisterProductControls() {
            document.getElementById('registerProductControls').removeAttribute('hidden');
        }

        function hideRegisterProductControls() {
            document.getElementById('registerProductControls').setAttribute('hidden', true);
        }

        async function docExists(db, docId, options = {}) {
            let ret = await db.get(docId, options).then((doc) => doc).catch(() => false)
            return ret
        }

        async function logInHandle(event) {
            event.preventDefault();
            let loggedInUserDb = new PouchDB('faces_loggedin_user_db')
            let loggedInUser = await docExists(loggedInUserDb, 'loggedin_user')
            if (!loggedInUser) {
                loggedInUser = { '_id': 'loggedin_user' }
            }
            loggedInUser['username'] = $('#username').val()
            loggedInUser['loginTime'] = new Date()
            await loggedInUserDb.put(loggedInUser)
            window.location.href = 'index.html';
        }

        async function registerProduct(event) {
            event.preventDefault();
            let importedPublicKey = await window.CryptoKeyUtils.importPublicKeyFromStr(publicKey);
            let signature = document.getElementById('licenseKey').value.trim();
            let verifyResult = await window.CryptoKeyUtils.verifyStr(device.uuid, signature, importedPublicKey);
            if(verifyResult) {
                let doc = {
                    '_id': 'licenseKey',
                    'value': signature
                }
                let licenseDB = new PouchDB('faces_licensekey_db');
                let existingDoc = await docExists(licenseDB, 'licenseKey');
                if(existingDoc) {
                    doc = existingDoc;
                    doc.value = signature;
                }
                await licenseDB.put(doc);
                showLoginControls();
                hideRegisterProductControls();
                return;
            }
            alert('Invalid License Key.');
        }

        async function pageOnDeviceReady() {
            // Check if product is registered
            let uuid = device.uuid;
            document.getElementById('deviceid').value = uuid;
            document.getElementById('licenseKey').value = '';
            let licenseDB = new PouchDB('faces_licensekey_db');
            let licenseKey = await docExists(licenseDB, 'licenseKey');
            if(!licenseKey) {
                hideLoginControls();
                showRegisterProductControls();
                return;
            }
            document.getElementById('licenseKey').value = licenseKey.value;
            let importedPublicKey = await window.CryptoKeyUtils.importPublicKeyFromStr(publicKey);
            let signature = document.getElementById('licenseKey').value.trim();
            let verifyResult = await window.CryptoKeyUtils.verifyStr(uuid, signature, importedPublicKey);
            if(!verifyResult) {
                hideLoginControls();
                showRegisterProductControls();
                return;
            }
        }

        document.addEventListener("deviceready", pageOnDeviceReady, false);
    </script>
</body>

</html>